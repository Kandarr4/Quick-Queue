{% block messenger_widget %}
<style>
.contact-panel {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 999;
}

.contact-panel-button {
    display: flex;
    align-items: center;
    background: var(--gradient-secondary);
    color: var(--white);
    padding: 1rem 1.5rem;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: var(--shadow-lg);
    transition: var(--transition);
    border: none;
    font-weight: 600;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.contact-panel-button:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 25px rgba(26, 188, 156, 0.3);
}

.contact-panel-button i {
    margin-right: 0.75rem;
    font-size: 1.25rem;
}

.contact-panel-content {
    position: absolute;
    bottom: 4.5rem;
    right: 0;
    width: 380px;
    height: 540px;
    max-height: 80vh;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(15px);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    padding: 1.5rem;
    transition: var(--transition);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transform: translateY(20px);
    opacity: 0;
    visibility: hidden;
    z-index: -1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    color: var(--light);
}

.contact-panel-content.active {
    transform: translateY(0);
    opacity: 1;
    visibility: visible;
    z-index: 1000;
}

.contact-panel-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    font-size: 1.25rem;
    color: var(--light);
    cursor: pointer;
    transition: var(--transition);
    z-index: 10;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.contact-panel-close:hover {
    background: var(--accent);
    color: var(--white);
    transform: rotate(90deg);
}

#contactFormContainer {
    overflow-y: auto;
    flex: 1;
}

#contactFormContainer h4 {
    margin-top: 0;
    margin-bottom: 0.5rem;
    font-size: 1.25rem;
    color: var(--light);
    font-weight: 600;
}

#contactFormContainer p {
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.7);
    line-height: 1.5;
}

.contact-form-group {
    margin-bottom: 1rem;
}

.contact-form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--light);
    font-size: 0.9rem;
    letter-spacing: 0.5px;
}

.contact-form-control {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-md);
    transition: var(--transition);
    font-size: 0.9rem;
    background: rgba(255, 255, 255, 0.05);
    color: var(--light);
    backdrop-filter: blur(5px);
}

.contact-form-control:focus {
    border-color: var(--secondary);
    box-shadow: 0 0 0 0.2rem rgba(26, 188, 156, 0.25);
    outline: none;
    background: rgba(255, 255, 255, 0.1);
}

.contact-form-control::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

textarea.contact-form-control {
    height: 90px;
    resize: none;
}

.contact-form-submit {
    display: block;
    width: 100%;
    padding: 0.8rem;
    background: var(--gradient-secondary);
    color: var(--white);
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    font-size: 1rem;
    text-align: center;
    margin-top: 1rem;
    box-shadow: var(--shadow-sm);
}

.contact-form-submit:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.chat-header {
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-header h5 {
    font-size: 1.2rem;
    margin: 0;
    color: var(--light);
    font-weight: 600;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding-right: 0.5rem;
    margin: 1rem 0;
}

.message {
    margin-bottom: 1rem;
    max-width: 85%;
    animation: fadeIn 0.3s ease forwards;
}

.message-content {
    padding: 0.8rem 1rem;
    border-radius: var(--radius-lg);
    position: relative;
    backdrop-filter: blur(5px);
}

.message-content p {
    margin: 0;
    font-size: 0.9rem;
    line-height: 1.4;
}

.message-time {
    font-size: 0.75rem;
    margin-top: 0.25rem;
    text-align: right;
    color: rgba(255, 255, 255, 0.6);
}

.system-message {
    text-align: center;
    margin: 1rem 0;
}

.system-welcome .message-content {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: var(--light);
}

.user-message {
    margin-left: auto;
}

.user-message .message-content {
    background: var(--gradient-secondary);
    color: var(--white);
    border-bottom-right-radius: 0.5rem;
}

.admin-message {
    margin-right: auto;
}

.admin-message .message-content {
    background: rgba(255, 255, 255, 0.1);
    color: var(--light);
    border-bottom-left-radius: 0.5rem;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.guest-message {
    margin-left: auto;
}

.guest-message .message-content {
    background: var(--gradient-secondary);
    color: var(--white);
    border-bottom-right-radius: 0.5rem;
}

.chat-input {
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.chat-input .input-group {
    display: flex;
}

.chat-input .form-control {
    flex: 1;
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-md) 0 0 var(--radius-md);
    background: rgba(255, 255, 255, 0.05);
    color: var(--light);
    transition: var(--transition);
}

.chat-input .form-control:focus {
    border-color: var(--secondary);
    box-shadow: 0 0 0 0.2rem rgba(26, 188, 156, 0.25);
    outline: none;
    background: rgba(255, 255, 255, 0.1);
}

.chat-input .form-control::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

.chat-input .btn {
    padding: 0.75rem 1rem;
    background: var(--secondary);
    color: var(--white);
    border: none;
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    transition: var(--transition);
}

.chat-input .btn:hover {
    background: #16a085;
    transform: translateY(-1px);
}

.unread-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--accent);
    color: var(--white);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
    box-shadow: var(--shadow-sm);
    animation: pulse 2s infinite;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

#chatContainer {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
}

.closed-chat-notification {
    background: rgba(231, 76, 60, 0.1);
    color: var(--accent);
    padding: 1.5rem;
    border-radius: var(--radius-md);
    margin: 1rem 0;
    text-align: center;
    border: 1px solid rgba(231, 76, 60, 0.2);
    animation: fadeIn 0.5s ease-in-out;
    flex-shrink: 0;
    backdrop-filter: blur(5px);
}

.closed-chat-notification button {
    margin-top: 1rem;
    background: var(--gradient-secondary);
    color: var(--white);
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition);
    font-weight: 600;
    box-shadow: var(--shadow-sm);
}

.closed-chat-notification button:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.typing-indicator {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    padding: 0.75rem 1rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-lg);
    max-width: 60%;
    margin-right: auto;
    animation: fadeIn 0.3s ease;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.typing-dots {
    display: flex;
    margin-right: 0.5rem;
}

.typing-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: var(--secondary);
    margin-right: 3px;
    animation: typingAnimation 1.5s infinite;
}

.typing-dot:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
    animation-delay: 0.4s;
    margin-right: 0;
}

@keyframes typingAnimation {
    0% { transform: translateY(0); opacity: 0.6; }
    50% { transform: translateY(-3px); opacity: 1; }
    100% { transform: translateY(0); opacity: 0.6; }
}

.connection-status {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    font-size: 0.8rem;
    z-index: 1050;
    display: none;
    backdrop-filter: blur(10px);
    font-weight: 500;
}

.connection-status.error {
    background: rgba(231, 76, 60, 0.1);
    color: var(--accent);
    border: 1px solid rgba(231, 76, 60, 0.2);
}

.connection-status.warning {
    background: rgba(243, 156, 18, 0.1);
    color: var(--warning);
    border: 1px solid rgba(243, 156, 18, 0.2);
}

.connection-status.success {
    background: rgba(46, 204, 113, 0.1);
    color: var(--success);
    border: 1px solid rgba(46, 204, 113, 0.2);
}

.badge {
    padding: 0.25rem 0.5rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.bg-success {
    background: var(--success) !important;
    color: var(--white) !important;
}

.bg-warning {
    background: var(--warning) !important;
    color: var(--white) !important;
}

.bg-danger {
    background: var(--accent) !important;
    color: var(--white) !important;
}

.text-dark {
    color: var(--dark) !important;
}

.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: rgba(26, 188, 156, 0.5);
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: rgba(26, 188, 156, 0.7);
}

@media (max-width: 576px) {
    .contact-panel-content {
        width: calc(100vw - 2rem);
        right: -1rem;
        height: 80vh;
    }
    
    .contact-panel-button span {
        display: none;
    }
    
    .contact-panel-button {
        padding: 1rem;
    }
    
    .contact-panel-button i {
        margin-right: 0;
    }
}
</style>

<div class="contact-panel" id="contactPanel">
    <div class="contact-panel-content" id="contactPanelContent">
        <button class="contact-panel-close" id="contactPanelClose">&times;</button>
        
        <div id="contactFormContainer">
            <h4 class="mb-2">Свяжитесь с нами</h4>
            <p class="text-muted mb-3">Напишите ваше сообщение, и мы ответим в течение нескольких минут.</p>
            
            <form id="contactForm">
                <div class="contact-form-group">
                    <label for="userName">Ваше имя</label>
                    <input type="text" id="userName" name="user_name" placeholder="Введите ваше имя" class="contact-form-control" required>
                </div>
                <div class="contact-form-group">
                    <label for="userContact">Контактные данные</label>
                    <input type="text" id="userContact" name="user_contact" placeholder="Email или телефон" class="contact-form-control" required>
                </div>
                <div class="contact-form-group">
                    <label for="contactMessage">Сообщение</label>
                    <textarea id="contactMessage" name="content" placeholder="Введите ваше сообщение..." class="contact-form-control" required></textarea>
                </div>
                <button type="submit" class="contact-form-submit">Отправить и начать чат</button>
            </form>
        </div>
        
        <div id="chatContainer" style="display: none;">
            <div class="chat-header d-flex justify-content-between align-items-center mb-2">
                <h5>Чат поддержки</h5>
                <span class="badge bg-success" id="connectionBadge">Онлайн</span>
            </div>
            
            <div class="chat-messages" id="chatMessages">
            </div>
            
            <div class="chat-input mt-2">
                <form id="chatForm">
                    <div class="input-group">
                        <input type="text" id="chatMessageInput" class="form-control" placeholder="Введите сообщение...">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="contact-panel-button" id="contactPanelButton">
        <i class="fas fa-comment-dots"></i>
        <span>Задать вопрос</span>
    </div>
    
    <div class="unread-badge" id="unreadBadge" style="display: none;">
        <span id="unreadCount">0</span>
    </div>
</div>

<div id="connectionStatus" class="connection-status"></div>

<script src="https://cdn.socket.io/4.6.0/socket.io.min.js" integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+" crossorigin="anonymous"></script>

<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous" onerror="null"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const BASE_URL = 'https://somnium.kz';
    const GUEST_MODE = true;
    
    const contactPanelButton = document.getElementById('contactPanelButton');
    const contactPanelContent = document.getElementById('contactPanelContent');
    const contactPanelClose = document.getElementById('contactPanelClose');
    const contactFormContainer = document.getElementById('contactFormContainer');
    const chatContainer = document.getElementById('chatContainer');
    const contactForm = document.getElementById('contactForm');
    const chatForm = document.getElementById('chatForm');
    const chatMessages = document.getElementById('chatMessages');
    const chatMessageInput = document.getElementById('chatMessageInput');
    const unreadBadge = document.getElementById('unreadBadge');
    const unreadCount = document.getElementById('unreadCount');
    const chatInputContainer = document.querySelector('.chat-input');
    const connectionBadge = document.getElementById('connectionBadge');
    const connectionStatus = document.getElementById('connectionStatus');
    
    let activeChat = null;
    let socket = null;
    let isChatClosed = false;
    let lastUserName = '';
    let isTyping = false;
    let typingTimer = null;
    let reconnectAttempts = 0;
    let reconnectInterval = null;
    
    let guestSessionId = localStorage.getItem('guest_session_id');
    if (!guestSessionId) {
        guestSessionId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('guest_session_id', guestSessionId);
    }

    if (chatMessageInput) {
        chatMessageInput.addEventListener('input', function() {
            if (!isTyping) {
                isTyping = true;
                if (socket && socket.connected && activeChat) {
                    socket.emit('typing', { chat_id: activeChat });
                }
            }

            clearTimeout(typingTimer);
            typingTimer = setTimeout(function() {
                isTyping = false;
            }, 2000);
        });
    }
    
    function updateConnectionStatus(message, status) {
        if (!connectionStatus) return;
        
        connectionStatus.textContent = message;
        connectionStatus.className = `connection-status ${status}`;
        connectionStatus.style.display = 'block';
        
        if (connectionBadge) {
            if (status === 'success') {
                connectionBadge.className = 'badge bg-success';
                connectionBadge.textContent = 'Онлайн';
            } else if (status === 'warning') {
                connectionBadge.className = 'badge bg-warning text-dark';
                connectionBadge.textContent = 'Переподключение...';
            } else if (status === 'error') {
                connectionBadge.className = 'badge bg-danger';
                connectionBadge.textContent = 'Офлайн';
            }
        }
        
        if (status === 'success') {
            setTimeout(() => {
                connectionStatus.style.display = 'none';
            }, 3000);
        }
    }
    
    function showTypingIndicator() {
        const existingIndicator = document.getElementById('typingIndicator');
        if (existingIndicator) {
            existingIndicator.remove();
        }
        
        const typingElement = document.createElement('div');
        typingElement.id = 'typingIndicator';
        typingElement.className = 'typing-indicator';
        
        typingElement.innerHTML = `
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            <span>Собеседник печатает...</span>
        `;
        
        chatMessages.appendChild(typingElement);
        scrollChatToBottom();
        
        setTimeout(function() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }, 3000);
    }
    
    function toggleChatPanel() {
        const isOpen = contactPanelContent.classList.toggle('active');
        
        if (isOpen) {
            unreadBadge.style.display = 'none';
            unreadCount.textContent = '0';
            
            if (activeChat) {
                loadChat(activeChat);
            }
        }
    }
    
    if (contactPanelButton) {
        contactPanelButton.addEventListener('click', toggleChatPanel);
    }
    
    if (contactPanelClose) {
        contactPanelClose.addEventListener('click', toggleChatPanel);
    }
    
	function initializeSocket() {
		if (typeof io === 'undefined') {
			updateConnectionStatus('Socket.IO не найден. Загрузка...', 'warning');
			
			const script = document.createElement('script');
			script.src = 'https://cdn.socket.io/4.6.0/socket.io.min.js';
			script.integrity = 'sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+';
			script.crossOrigin = 'anonymous';
			
			script.onload = function() {
				updateConnectionStatus('Socket.IO загружен', 'success');
				
				const socket = initializeSocket();
				
				if (activeChat) {
					setTimeout(() => {
						socket.emit('join_chat', { chat_id: activeChat });
					}, 1000);
				}
			};
			
			script.onerror = function() {
				updateConnectionStatus('Не удалось загрузить Socket.IO', 'error');
			};
			
			document.head.appendChild(script);
			return null;
		}
		
		if (socket) {
			socket.disconnect();
		}
		
		const socketURL = BASE_URL;
		
		try {
			let newSocket = io(socketURL + '/messenger', {
				path: '/socket.io/',
				reconnection: true,
				reconnectionAttempts: 5,
				reconnectionDelay: 1000,
				reconnectionDelayMax: 5000,
				timeout: 20000,
				autoConnect: true,
				transports: ['websocket', 'polling'],
				query: { 
					guest_id: guestSessionId,
					mode: GUEST_MODE ? 'guest' : 'user'
				}
			});
			
			newSocket.on('connect', function() {
				updateConnectionStatus('Подключено', 'success');
				
				if (activeChat) {
					newSocket.emit('join_chat', { chat_id: activeChat });
				}
				
				if (reconnectInterval) {
					clearInterval(reconnectInterval);
					reconnectInterval = null;
				}
			});
			
			newSocket.on('disconnect', function(reason) {
				updateConnectionStatus('Соединение потеряно: ' + reason, 'warning');
				
				if (!reconnectInterval) {
					reconnectInterval = setInterval(function() {
						if (!newSocket.connected) {
							reconnectAttempts++;
							updateConnectionStatus(`Переподключение: попытка ${reconnectAttempts}`, 'warning');
							
							if (reconnectAttempts > 5) {
								clearInterval(reconnectInterval);
								reconnectInterval = null;
								updateConnectionStatus('Не удалось подключиться', 'error');
							} else {
								newSocket.connect();
							}
						}
					}, 5000);
				}
			});
			
			newSocket.on('connect_error', function(error) {
				updateConnectionStatus('Ошибка подключения', 'error');
			});
			
			newSocket.on('joined_chat', function(data) {
			});
			
			newSocket.on('new_message', function(data) {
				if (data.chat_id == activeChat) {
					const isMyMessage = (data.sender_type === 'user' && !GUEST_MODE) || 
									   (data.sender_type === 'guest' && GUEST_MODE);
					
					if (!isMyMessage) {
						const typingIndicator = document.getElementById('typingIndicator');
						if (typingIndicator) {
							typingIndicator.remove();
						}
						
						const newMessage = {
							text: data.content,
							sender_type: data.sender_type,
							is_my_message: false,
							created_at: data.created_at
						};
						
						addMessageToChat(newMessage);
						saveMessageToLocalStorage(activeChat, newMessage);
						scrollChatToBottom();
						
						if (newSocket && newSocket.connected) {
							newSocket.emit('read_messages', { chat_id: activeChat });
						}
						
						playNotificationSound();
					}
				} else {
					if (!contactPanelContent.classList.contains('active')) {
						unreadBadge.style.display = 'flex';
						unreadCount.textContent = parseInt(unreadCount.textContent || '0') + 1;
						playNotificationSound();
					}
				}
			});
			
			newSocket.on('new_chat_notification', function(data) {
				if (!contactPanelContent.classList.contains('active') || data.chat_id != activeChat) {
					unreadBadge.style.display = 'flex';
					unreadCount.textContent = parseInt(unreadCount.textContent || '0') + 1;
					playNotificationSound();
				}
			});
			
			newSocket.on('typing', function(data) {
				if (data.chat_id == activeChat) {
					showTypingIndicator();
				}
			});
			
			newSocket.on('messages_read', function(data) {
				if (data.chat_id == activeChat) {
					markMessagesAsRead();
				}
			});
			
			newSocket.on('chat_closed', function(data) {
				if (data.chat_id == activeChat) {
					isChatClosed = true;
					addClosedChatNotification();
					
					const systemMessage = {
						text: data.message || 'Чат был закрыт администратором.',
						sender_type: 'system',
						is_my_message: false,
						created_at: data.created_at || new Date().toISOString()
					};
					
					addMessageToChat(systemMessage);
					saveMessageToLocalStorage(activeChat, systemMessage);
					scrollChatToBottom();
				}
			});
			
			newSocket.on('chat_reopened', function(data) {
				if (data.chat_id == activeChat) {
					isChatClosed = false;
					
					const notificationElement = document.getElementById('closedChatNotification');
					if (notificationElement) {
						notificationElement.remove();
					}

					if (chatInputContainer) {
						chatInputContainer.style.display = 'block';
					}
					
					const systemMessage = {
						text: data.message || 'Чат был переоткрыт.',
						sender_type: 'system',
						is_my_message: false,
						created_at: data.created_at || new Date().toISOString()
					};
					
					addMessageToChat(systemMessage);
					saveMessageToLocalStorage(activeChat, systemMessage);
					scrollChatToBottom();
				}
			});
			
			newSocket.on('connect', function() {
				if (GUEST_MODE) {
					newSocket.emit('get_guest_chats', { guest_id: guestSessionId });
				}
			});
			
			newSocket.on('guest_chats', function(data) {
				if (data.chats && data.chats.length > 0) {
					const lastChat = data.chats[0];
					activeChat = lastChat.id;
					localStorage.setItem('active_chat_id', activeChat);
					
					if (contactPanelContent.classList.contains('active')) {
						loadChat(activeChat);
					} else {
						unreadBadge.style.display = 'flex';
						unreadCount.textContent = '1';
					}
				}
			});
			
			return newSocket;
		} catch (error) {
			updateConnectionStatus('Ошибка создания Socket.IO', 'error');
			return null;
		}
	}
    
    function getCSRFToken() {
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        if (csrfMeta && csrfMeta.getAttribute('content')) {
            return csrfMeta.getAttribute('content');
        }
        
        const csrfInput = document.querySelector('input[name="csrf_token"]');
        if (csrfInput && csrfInput.value) {
            return csrfInput.value;
        }
        
        return 'guest-csrf-token-' + new Date().getTime();
    }
    
    function createNewChat(customTitle = '') {
        if (!customTitle) {
            const savedUserInfo = localStorage.getItem('user_info');
            if (savedUserInfo) {
                const userInfo = JSON.parse(savedUserInfo);
                customTitle = userInfo.name ? `Чат с ${userInfo.name}` : 'Новый чат';
            } else {
                customTitle = 'Новый чат';
            }
        }
        
        const csrfToken = getCSRFToken();
        
        const headers = {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
        };
        
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }
        
        return fetch(BASE_URL + '/messenger/create_chat', {
            method: 'POST',
            headers: headers,
            body: new URLSearchParams({
                'title': customTitle,
                'guest_id': guestSessionId,
                'mode': GUEST_MODE ? 'guest' : 'user'
            }),
            credentials: 'include'
        })
        .then(response => {
            const contentType = response.headers.get('Content-Type');
            if (contentType && contentType.includes('text/html')) {
                throw new Error('Сервер вернул HTML вместо JSON. Возможно, проблема с настройками CORS или CSRF.');
            }
            
            if (!response.ok) {
                throw new Error(`Ошибка при создании чата: ${response.status}`);
            }
            
            return response.json();
        })
        .then(data => {
            return data;
        })
        .catch(error => {
            const localChatId = 'local_' + new Date().getTime();
            
            return {
                success: true,
                chat_id: localChatId,
                chat: {
                    id: localChatId,
                    title: customTitle,
                    status: 'open'
                }
            };
        });
    }
    
    function loadChat(chatId) {
        activeChat = chatId;
        localStorage.setItem('active_chat_id', chatId);
        
        if (!socket || !socket.connected) {
            socket = initializeSocket();
        }
        
        if (socket && socket.connected) {
            socket.emit('join_chat', { chat_id: chatId });
        }
        
        if (contactFormContainer) contactFormContainer.style.display = 'none';
        if (chatContainer) chatContainer.style.display = 'flex';
        
        if (!chatMessages) {
            return;
        }
        
        chatMessages.innerHTML = '';
        
        const systemDateElement = document.createElement('div');
        systemDateElement.className = 'system-message text-center my-2';
        systemDateElement.innerHTML = `<span class="badge bg-light text-dark">Сегодня</span>`;
        chatMessages.appendChild(systemDateElement);
        
        const loadingIndicator = document.createElement('div');
        loadingIndicator.className = 'text-center my-3';
        loadingIndicator.innerHTML = `
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
        `;
        chatMessages.appendChild(loadingIndicator);
        
        const isLocalChat = chatId.startsWith('local_');
        
        const cachedMessages = getMessagesFromLocalStorage(chatId);
        if (isLocalChat || (cachedMessages && cachedMessages.length > 0)) {
            loadingIndicator.remove();
            
            const chatStatus = localStorage.getItem('chat_status_' + chatId) || 'open';
            if (chatStatus === 'resolved' || chatStatus === 'closed') {
                isChatClosed = true;
                addClosedChatNotification();
            } else {
                isChatClosed = false;
                if (chatInputContainer) {
                    chatInputContainer.style.display = 'block';
                }
            }
            
            if (cachedMessages && cachedMessages.length > 0) {
                cachedMessages.forEach(message => {
                    addMessageToChat(message);
                });
            } else {
                const welcomeMessage = {
                    text: "Здравствуйте! Чем мы можем помочь вам сегодня?",
                    sender_type: 'admin',
                    is_my_message: false,
                    created_at: new Date().toISOString()
                };
                addMessageToChat(welcomeMessage);
                saveMessageToLocalStorage(chatId, welcomeMessage);
            }
            
            scrollChatToBottom();
            
            if (!isLocalChat) {
                try {
                    fetch(BASE_URL + '/messenger/chat/' + chatId, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        },
                        credentials: 'include'
                    })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        }
                        throw new Error(`Server response: ${response.status}`);
                    })
                    .then(data => {
                        if (data.success && data.messages) {
                            if (data.chat && data.chat.status) {
                                localStorage.setItem('chat_status_' + chatId, data.chat.status);
                                
                                if (data.chat.status === 'resolved' || data.chat.status === 'closed') {
                                    isChatClosed = true;
                                    addClosedChatNotification();
                                }
                            }
                            
                            const existingIds = cachedMessages.filter(m => m.id).map(m => m.id);
                            const newMessages = data.messages.filter(m => !existingIds.includes(m.id));
                            
                            if (newMessages.length > 0) {
                                newMessages.forEach(message => {
                                    const messageObj = {
                                        id: message.id,
                                        text: message.content,
                                        sender_type: message.sender_type,
                                        is_my_message: message.sender_type === (GUEST_MODE ? 'guest' : 'user'),
                                        created_at: message.created_at
                                    };
                                    
                                    addMessageToChat(messageObj);
                                    saveMessageToLocalStorage(chatId, messageObj);
                                });
                                
                                scrollChatToBottom();
                            }
                        }
                    })
                    .catch(error => {
                    });
                } catch (e) {
                }
            }
            
            return;
        }
        
        fetch(BASE_URL + '/messenger/chat/' + chatId, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            },
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server response: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            loadingIndicator.remove();
            
            if (data.success) {
                if (data.chat && data.chat.status) {
                    localStorage.setItem('chat_status_' + chatId, data.chat.status);
                }
                
                if (data.chat && (data.chat.status === 'resolved' || data.chat.status === 'closed')) {
                    isChatClosed = true;
                    addClosedChatNotification();
                } else {
                    isChatClosed = false;
                    if (chatInputContainer) {
                        chatInputContainer.style.display = 'block';
                    }
                }
                
                if (data.messages && data.messages.length > 0) {
                    localStorage.removeItem('chat_messages_' + chatId);
                    
                    data.messages.forEach(message => {
                        const messageObj = {
                            id: message.id,
                            text: message.content,
                            sender_type: message.sender_type,
                            is_my_message: message.sender_type === (GUEST_MODE ? 'guest' : 'user'),
                            created_at: message.created_at
                        };
                        
                        addMessageToChat(messageObj);
                        saveMessageToLocalStorage(chatId, messageObj);
                    });
                } else {
                    const welcomeMessage = {
                        text: "Здравствуйте! Чем мы можем помочь вам сегодня?",
                        sender_type: 'admin',
                        is_my_message: false,
                        created_at: new Date().toISOString()
                    };
                    addMessageToChat(welcomeMessage);
                    saveMessageToLocalStorage(chatId, welcomeMessage);
                }
            } else {
                throw new Error('No success in response data');
            }
            
            scrollChatToBottom();
            
            if (socket && socket.connected) {
                socket.emit('read_messages', { chat_id: chatId });
            }
        })
        .catch(error => {
            loadingIndicator.remove();
            
            const errorMessage = document.createElement('div');
            errorMessage.className = 'alert alert-danger my-3';
            errorMessage.textContent = 'Не удалось загрузить сообщения с сервера.';
            chatMessages.appendChild(errorMessage);
            
            const cachedMessages = getMessagesFromLocalStorage(chatId);
            if (cachedMessages && cachedMessages.length > 0) {
                setTimeout(() => {
                    errorMessage.remove();
                    
                    cachedMessages.forEach(message => {
                        addMessageToChat(message);
                    });
                    
                    scrollChatToBottom();
                }, 2000);
            } else {
                setTimeout(() => {
                    errorMessage.remove();
                    
                    const welcomeMessage = {
                        text: "Здравствуйте! Чем мы можем помочь вам сегодня?",
                        sender_type: 'admin',
                        is_my_message: false,
                        created_at: new Date().toISOString()
                    };
                    addMessageToChat(welcomeMessage);
                    saveMessageToLocalStorage(chatId, welcomeMessage);
                    
                    scrollChatToBottom();
                }, 2000);
            }
        });
    }

    function addClosedChatNotification() {
        if (chatInputContainer) {
            chatInputContainer.style.display = 'none';
        }

        if (document.getElementById('closedChatNotification')) {
            return;
        }

        const notificationElement = document.createElement('div');
        notificationElement.className = 'closed-chat-notification'; 
        notificationElement.id = 'closedChatNotification';
        
        notificationElement.innerHTML = `
            <p style="margin-bottom: 8px;"><strong>Ваш чат был закрыт.</strong></p>
            <p style="margin: 0;">Хотите создать новый чат?</p>
            <button id="reopenChatBtn" class="btn btn-primary" style="margin-top: 10px;">Да, создать новый чат</button>
        `;

        const chatContainer = document.getElementById('chatContainer');
        if (chatContainer) {
            chatContainer.appendChild(notificationElement);
        }

        const reopenButton = document.getElementById('reopenChatBtn');
        if (reopenButton) {
            reopenButton.addEventListener('click', function() {
                const notification = document.getElementById('closedChatNotification');
                if (notification) {
                    notification.remove();
                }
                
                if (contactFormContainer) {
                    contactFormContainer.style.display = 'block';
                }
                if (chatContainer) {
                    chatContainer.style.display = 'none';
                }
            });
        }
    }
    
    function sendMessage(chatId, messageText) {
        const csrfToken = getCSRFToken();
        
        const extraParams = GUEST_MODE ? { guest_id: guestSessionId } : {};
        
        return fetch(BASE_URL + '/messenger/send_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({
                'chat_id': chatId,
                'content': messageText,
                'force_send': 'false',
                ...extraParams
            }),
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Ошибка отправки: ${response.status}`);
            }
            return response.json();
        })
        .catch(error => {
            return {
                success: true,
                message_id: 'local_' + new Date().getTime(),
                chat_id: chatId,
                created_at: new Date().toISOString()
            };
        });
    }
    
    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!activeChat) {
                if (typeof showNotification === 'function') {
                    showNotification('Ошибка', 'Чат не найден', 'error');
                } else {
                    alert('Ошибка: Чат не найден');
                }
                return;
            }
            
            const messageText = chatMessageInput.value.trim();
            if (!messageText) return;
            
            if (isChatClosed) {
                if (typeof showNotification === 'function') {
                    showNotification('Внимание', 'Чат закрыт. Пожалуйста, нажмите кнопку "Создать новый чат", чтобы продолжить.', 'warning');
                } else {
                    alert('Чат закрыт. Пожалуйста, нажмите кнопку "Создать новый чат", чтобы продолжить.');
                }
                
                const notificationElement = document.getElementById('closedChatNotification');
                if (notificationElement) {
                    notificationElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    notificationElement.style.boxShadow = '0 0 10px rgba(220, 53, 69, 0.7)';
                    setTimeout(() => {
                        notificationElement.style.boxShadow = 'none';
                        notificationElement.style.transition = 'box-shadow 0.5s';
                    }, 2000);
                }
                return;
            }
            
            const senderType = GUEST_MODE ? 'guest' : 'user';

            const newMessage = {
                text: messageText,
                sender_type: senderType,
                is_my_message: true,
                created_at: new Date().toISOString()
            };
            
            addMessageToChat(newMessage);
            saveMessageToLocalStorage(activeChat, newMessage);
            scrollChatToBottom();
            
            chatMessageInput.value = '';
            
            sendMessage(activeChat, messageText)
                .then(data => {
                    if (data.success) {
                        const messages = getMessagesFromLocalStorage(activeChat);
                        if (messages.length > 0) {
                            const lastMessage = messages[messages.length - 1];
                            if (lastMessage.text === messageText) {
                                lastMessage.created_at = data.created_at;
                                localStorage.setItem('chat_messages_' + activeChat, JSON.stringify(messages));
                            }
                        }
                    } else {
                        const messageElements = chatMessages.querySelectorAll('.message');
                        const lastElement = messageElements[messageElements.length - 1];
                        if (lastElement && (lastElement.classList.contains('user-message') || lastElement.classList.contains('guest-message'))) {
                            lastElement.remove();
                        }
                        
                        const messages = getMessagesFromLocalStorage(activeChat);
                        if (messages.length > 0 && messages[messages.length - 1].text === messageText) {
                            messages.pop();
                            localStorage.setItem('chat_messages_' + activeChat, JSON.stringify(messages));
                        }
                        
                        if (data.message && data.message.includes('закрыт')) {
                            isChatClosed = true;
                            addClosedChatNotification();
                            
                            if (typeof showNotification === 'function') {
                                showNotification('Внимание', 'Чат закрыт. Пожалуйста, нажмите кнопку "Создать новый чат", чтобы продолжить.', 'warning');
                            } else {
                                alert('Чат закрыт. Пожалуйста, нажмите кнопку "Создать новый чат", чтобы продолжить.');
                            }
                        } else {
                            if (typeof showNotification === 'function') {
                                showNotification('Ошибка', data.message || 'Не удалось отправить сообщение', 'error');
                            } else {
                                alert('Ошибка: ' + (data.message || 'Не удалось отправить сообщение'));
                            }
                        }
                    }
                })
                .catch(error => {
                });
        });
    }
    
    if (contactForm) {
        contactForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
			const userName = document.getElementById('userName')?.value || '';
			const userContact = document.getElementById('userContact')?.value || '';
			const messageContent = document.getElementById('contactMessage')?.value || '';
            
            lastUserName = userName;
            
            const fullContent = `Имя: ${userName}\nКонтакты: ${userContact}\n\n${messageContent}`;
            
            localStorage.setItem('user_info', JSON.stringify({
                name: userName,
                contact: userContact
            }));
            
            const submitBtn = this.querySelector('button[type="submit"]');
            if (!submitBtn) return;
            
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin me-2"></i>Отправка...';
            submitBtn.disabled = true;
            
            const chatTitle = `Чат с ${userName}`;
            
            createNewChat(chatTitle)
            .then(data => {
                if (data.success) {
                    const chatId = data.chat_id;
                    
                    return sendMessage(chatId, fullContent)
                    .then(messageData => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        
                        const userMessage = {
                            text: messageContent,
                            sender_type: GUEST_MODE ? 'guest' : 'user',
                            is_my_message: true,
                            created_at: messageData.created_at || new Date().toISOString()
                        };
                        
                        saveMessageToLocalStorage(chatId, userMessage);
                        
                        loadChat(chatId);
                        
                        return messageData;
                    });
                } else {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    throw new Error(data.message || 'Не удалось создать чат');
                }
            })
            .catch(error => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
                if (typeof showNotification === 'function') {
                    showNotification('Ошибка', error.message || 'Не удалось отправить сообщение', 'error');
                } else {
                    alert('Ошибка: ' + (error.message || 'Не удалось отправить сообщение'));
                }
            });
        });
    }
    
    function addMessageToChat(message) {
        const messageElement = document.createElement('div');
        
        if (message.sender_type === 'admin') {
            messageElement.className = 'admin-message message';
        } else if (message.sender_type === 'user') {
            messageElement.className = 'user-message message';
        } else if (message.sender_type === 'guest') {
            messageElement.className = 'guest-message message';
        } else if (message.sender_type === 'system') {
            messageElement.className = 'system-message system-welcome message';
        }
        
        let timeString = '';
        if (message.created_at) {
            const messageDate = new Date(message.created_at);
            timeString = messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else {
            timeString = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        messageElement.innerHTML = `
            <div class="message-content">
                <p>${message.text}</p>
            </div>
            <div class="message-time">
                <small class="text-muted">${timeString}</small>
            </div>
        `;
        
        chatMessages.appendChild(messageElement);
    }
    
    function scrollChatToBottom() {
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }
    
    function saveMessageToLocalStorage(chatId, message) {
        const messageHistory = localStorage.getItem('chat_messages_' + chatId) 
            ? JSON.parse(localStorage.getItem('chat_messages_' + chatId)) 
            : [];
        
        messageHistory.push(message);
        localStorage.setItem('chat_messages_' + chatId, JSON.stringify(messageHistory));
    }
    
    function getMessagesFromLocalStorage(chatId) {
        const localMessages = localStorage.getItem('chat_messages_' + chatId);
        return localMessages ? JSON.parse(localMessages) : [];
    }
    
    function playNotificationSound() {
        let soundElement = document.getElementById('notificationSound');
        
        if (!soundElement) {
            soundElement = document.createElement('audio');
            soundElement.id = 'notificationSound';
            soundElement.preload = 'auto';
            
            const mp3Source = document.createElement('source');
            mp3Source.src = BASE_URL + '/static/sounds/notification.mp3';
            mp3Source.type = 'audio/mpeg';
            soundElement.appendChild(mp3Source);
            
            const oggSource = document.createElement('source');
            oggSource.src = BASE_URL + '/static/sounds/notification.ogg';
            oggSource.type = 'audio/ogg';
            soundElement.appendChild(oggSource);
            
            document.body.appendChild(soundElement);
        }
        
        soundElement.play().catch(error => {
        });
    }
    
    function markMessagesAsRead() {
        const unreadMessages = chatMessages.querySelectorAll('.message:not(.read)');
        unreadMessages.forEach(message => {
            message.classList.add('read');
        });
    }
    
    function loadChatHistory() {
        const activeChatId = localStorage.getItem('active_chat_id');
        if (activeChatId) {
            loadChat(activeChatId);
        }
    }
    
    function checkConnection() {
        if (socket && !socket.connected) {
            updateConnectionStatus("Переподключение...", "warning");
            
            socket.connect();
        }
    }
    
    function showNotification(title, message, type) {
        const notificationId = 'custom-notification-' + new Date().getTime();
        
        const notification = document.createElement('div');
        notification.id = notificationId;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            min-width: 250px;
            max-width: 350px;
            animation: fadeIn 0.3s ease;
        `;
        
        if (type === 'success') {
            notification.style.backgroundColor = '#d4edda';
            notification.style.color = '#155724';
            notification.style.borderLeft = '4px solid #28a745';
        } else if (type === 'error') {
            notification.style.backgroundColor = '#f8d7da';
            notification.style.color = '#721c24';
            notification.style.borderLeft = '4px solid #dc3545';
        } else if (type === 'warning') {
            notification.style.backgroundColor = '#fff3cd';
            notification.style.color = '#856404';
            notification.style.borderLeft = '4px solid #ffc107';
        } else {
            notification.style.backgroundColor = '#d1ecf1';
            notification.style.color = '#0c5460';
            notification.style.borderLeft = '4px solid #17a2b8';
        }
        
        notification.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 5px;">${title}</div>
            <div>${message}</div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.3s ease';
            
            setTimeout(() => {
                if (notification && notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }
    
    setInterval(checkConnection, 10000);
    
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && (!socket || !socket.connected)) {
            socket = initializeSocket();
            
            if (activeChat) {
                loadChat(activeChat);
            }
        }
    });
    
    setInterval(function() {
        if (activeChat && (!socket || !socket.connected)) {
            fetch(`${BASE_URL}/messenger/chat/${activeChat}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                },
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.messages) {
                    renderChatMessages(data.messages);
                }
            })
            .catch(error => {});
        }
    }, 5000);
    
    function renderChatMessages(messages) {
        const existingMessages = getMessagesFromLocalStorage(activeChat);
        const existingIds = existingMessages.map(m => m.id).filter(id => id);
        
        const newMessages = messages.filter(message => !existingIds.includes(message.id));
        
        if (newMessages.length > 0) {
            newMessages.forEach(message => {
                const messageObj = {
                    id: message.id,
                    text: message.content,
                    sender_type: message.sender_type,
                    is_my_message: message.sender_type === (GUEST_MODE ? 'guest' : 'user'),
                    created_at: message.created_at
                };
                
                addMessageToChat(messageObj);
                saveMessageToLocalStorage(activeChat, messageObj);
            });
            
            scrollChatToBottom();
        }
    }
    
    const activeChatId = localStorage.getItem('active_chat_id');
    if (activeChatId) {
        activeChat = activeChatId;
        
        if (!contactPanelContent.classList.contains('active')) {
            unreadBadge.style.display = 'flex';
            unreadCount.textContent = '1';
        } else {
            loadChatHistory();
        }
    }
    
    const savedUserInfo = localStorage.getItem('user_info');
    if (savedUserInfo) {
        const userInfo = JSON.parse(savedUserInfo);
        if (document.getElementById('userName')) {
            document.getElementById('userName').value = userInfo.name || '';
        }
        if (document.getElementById('userContact')) {
            document.getElementById('userContact').value = userInfo.contact || '';
        }
    }
    
    socket = initializeSocket();
});

</script>
{% endblock %}